{% extends "layout/layout_vertical.html" %}
{% load static %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Delivery Orders</h5>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="syncMobileData()">
                    <i class="bx bx-sync me-1"></i>
                    Sync Mobile Data
                </button>
            </div>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Delivery Orders</h5>
            <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#createDeliveryOrderModal">
                <i class="bx bx-plus me-1"></i>
                Create Delivery Order
            </button>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <input type="date" class="form-control" id="delivery-date-filter">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Route</label>
                    <select class="form-select" id="route-filter">
                        <option value="">All Routes</option>
                        {% for route in routes %}
                        <option value="{{ route.id }}">{{ route.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="status-filter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="delivered">Delivered</option>
                        <option value="partially_delivered">Partially Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order Number</th>
                            <th>Seller</th>
                            <th>Route</th>
                            <th>Delivery Date</th>
                            <th>Total Amount</th>
                            <th>Paid Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in delivery_orders %}
                        <tr>
                            <td>{{ order.order_number }}</td>
                            <td>{{ order.seller.store_name }}</td>
                            <td>{{ order.route.name }}</td>
                            <td>{{ order.delivery_date }}</td>
                            <td>{{ order.total_amount|floatformat:2 }}</td>
                            <td>{{ order.paid_amount|floatformat:2 }}</td>
                            <td>
                                <span class="badge bg-label-{{ order.status_color }}">
                                    {{ order.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'delivery:delivery-order-detail' order.id %}"
                                       class="btn btn-icon btn-sm btn-outline-primary">
                                        <i class="bx bx-show"></i>
                                    </a>
                                    {% if order.status == 'pending' %}
                                    <a href="{% url 'delivery:delivery-order-edit' order.id %}"
                                       class="btn btn-icon btn-sm btn-outline-warning">
                                        <i class="bx bx-edit"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No delivery orders found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Delivery Order Modal -->
<div class="modal fade" id="createDeliveryOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            {% include "delivery/partials/delivery_order_modal.html" %}
        </div>
    </div>
</div>

<script>
    // Reset form when modal is closed
    document.getElementById('createDeliveryOrderModal').addEventListener('hidden.bs.modal', function () {
        // Reset the form
        document.getElementById('deliveryOrderForm').reset();

        // Clear order items
        if (window.orderItems) {
            window.orderItems = [];
        }

        // Hide order items section
        const orderItems = document.getElementById('orderItems');
        if (orderItems) {
            orderItems.style.display = 'none';
        }

        // Clear order items table
        const orderItemsBody = document.getElementById('orderItemsBody');
        if (orderItemsBody) {
            orderItemsBody.innerHTML = '';
        }

        // Remove any alert messages
        const editingAlert = document.getElementById('editingAlert');
        if (editingAlert) {
            editingAlert.remove();
        }

        // Reset form action to create URL
        document.getElementById('deliveryOrderForm').action = "{% url 'delivery:delivery-order-create' %}";
    });
</script>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    function syncMobileData() {
        // This will be implemented later for mobile app integration
        alert('Mobile data synchronization will be implemented in the future.');
    }

    // Add filter functionality
    document.getElementById('delivery-date-filter').addEventListener('change', filterOrders);
    document.getElementById('route-filter').addEventListener('change', filterOrders);
    document.getElementById('status-filter').addEventListener('change', filterOrders);

    function filterOrders() {
        // Implement filter logic here
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle filters
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');
        const routeFilter = document.getElementById('routeFilter');

        function applyFilters() {
            const params = new URLSearchParams(window.location.search);
            params.set('status', statusFilter.value);
            params.set('date', dateFilter.value);
            params.set('route', routeFilter.value);
            window.location.search = params.toString();
        }

        statusFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        routeFilter.addEventListener('change', applyFilters);
    });
</script>
{% endblock %}