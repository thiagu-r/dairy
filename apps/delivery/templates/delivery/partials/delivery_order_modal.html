<div class="modal-header">
    <h5 class="modal-title">Create Delivery Order</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <form id="deliveryOrderForm" method="POST">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Route</label>
                <select class="form-select" name="route_id" id="routeSelect" required>
                    <option value="">Select Route</option>
                    {% for route in routes %}
                    <option value="{{ route.id }}">{{ route.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Seller</label>
                <select class="form-select" name="seller_id" id="sellerSelect" required disabled>
                    <option value="">Select Seller</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Delivery Date</label>
                <input type="date" class="form-control" name="delivery_date" id="deliveryDate" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Delivery Time</label>
                <input type="time" class="form-control" name="delivery_time" required>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Payment Method</label>
                <select class="form-select" name="payment_method" required>
                    <option value="cash">Cash</option>
                    <option value="credit">Credit</option>
                    <option value="bank_transfer">Bank Transfer</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Opening Balance</label>
                <input type="text" class="form-control" id="openingBalance" readonly>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="notes" rows="2"></textarea>
        </div>

        <div id="orderItems">
            <h6>Order Items</h6>
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Ordered Qty</th>
                        <th>Delivered Qty</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="orderItemsBody"></tbody>
            </table>
            <button type="button" class="btn btn-sm btn-primary" id="addItemBtn">Add Item</button>
        </div>

        <div class="row mt-3">
            <div class="col-md-4">
                <label class="form-label">Amount Collected</label>
                <input type="number" class="form-control" name="amount_collected" id="amountCollected" value="0" step="0.01">
            </div>
            <div class="col-md-4">
                <label class="form-label">Total Amount</label>
                <input type="text" class="form-control" id="totalAmount" readonly>
            </div>
            <div class="col-md-4">
                <label class="form-label">Total Balance</label>
                <input type="text" class="form-control" id="totalBalance" readonly>
            </div>
        </div>

        <div class="alert alert-danger d-none" id="errorMessage"></div>
    </form>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Close</button>
    <button type="submit" class="btn btn-primary" form="deliveryOrderForm">Create Order</button>
</div>


<!-- Add a new section for order items -->
<div id="orderItemsSection" style="display: none;">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Ordered Qty</th>
                    <th>Delivered Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="orderItemsBody"></tbody>
        </table>
    </div>
    
    <!-- Add Product Button -->
    <button type="button" class="btn btn-secondary mt-2" id="addProductBtn">
        Add Additional Product
    </button>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Product</label>
                    <select class="form-select" id="productSelect"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="productQuantity" min="0" step="0.001">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmAddProduct">Add</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const routeSelect = document.getElementById('routeSelect');
        const sellerSelect = document.getElementById('sellerSelect');
        const deliveryDate = document.getElementById('deliveryDate');
        const orderItemsSection = document.getElementById('orderItemsSection');
        const orderItemsBody = document.getElementById('orderItemsBody');
        const addProductBtn = document.getElementById('addProductBtn');
        
        let orderItems = [];
        let availableProducts = [];
    
        // Load sellers when route is selected
        routeSelect.addEventListener('change', function() {
            const routeId = this.value;
            sellerSelect.innerHTML = '<option value="">Select Seller</option>';
            sellerSelect.disabled = true;
            orderItemsSection.style.display = 'none';
            
            if (routeId) {
                fetch(`/api/routes/${routeId}/sellers/`)
                    .then(response => response.json())
                    .then(data => {
                        data.sellers.forEach(seller => {
                            const option = new Option(seller.store_name, seller.id);
                            sellerSelect.add(option);
                        });
                        sellerSelect.disabled = false;
                    });
            }
        });
    
        // Load sales order items when seller and date are selected
        function loadOrderItems() {
            const sellerId = sellerSelect.value;
            const routeId = routeSelect.value;
            const date = deliveryDate.value;
    
            if (!sellerId || !routeId || !date) return;
    
            // Load sales order items
            fetch(`/api/sales-items/?seller=${sellerId}&route=${routeId}&date=${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    orderItems = data.items.map(item => ({
                        product_id: item.product_id,
                        product_name: item.product_name,
                        ordered_quantity: item.quantity,
                        delivered_quantity: item.quantity,
                        unit_price: item.unit_price,
                        total: item.quantity * item.unit_price
                    }));
                    updateOrderItemsTable();
                    orderItemsSection.style.display = 'block';
                    
                    // Load available products from loading order
                    return fetch(`/api/routes/${routeId}/available-products/?date=${date}`);
                })
                .catch(error => {
                    console.error('Error:', error);
                    orderItemsSection.style.display = 'none';
                });
        }
    
        sellerSelect.addEventListener('change', loadOrderItems);
        deliveryDate.addEventListener('change', loadOrderItems);
    
        // Update order items table
        function updateOrderItemsTable() {
            orderItemsBody.innerHTML = orderItems.map(item => `
                <tr>
                    <td>${item.product_name}</td>
                    <td>${item.ordered_quantity}</td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               value="${item.delivered_quantity}"
                               onchange="updateDeliveredQuantity('${item.product_id}', this.value)">
                    </td>
                    <td>${item.unit_price}</td>
                    <td>${(item.delivered_quantity * item.unit_price).toFixed(2)}</td>
                </tr>
            `).join('');
        }
    
        // Add new product
        addProductBtn.addEventListener('click', function() {
            // Show modal with available products from loading order
            // that are not already in the order items
            const usedProductIds = orderItems.map(item => item.product_id);
            const availableForAdd = availableProducts.filter(p => !usedProductIds.includes(p.id));
            
            // Show product selection modal
            // Implementation depends on your UI framework
        });
    });
    </script>